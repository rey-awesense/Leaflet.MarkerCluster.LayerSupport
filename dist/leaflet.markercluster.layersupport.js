/**
 * @license leaflet.markercluster.layersupport v1.0.0
 * Sub-plugin for Leaflet.markercluster. Brings compatibility with L.Control.Layers
 * (c) 2015-2016 Boris Seang
 * License: MIT
 */
!function(e,r){"function"==typeof define&&define.amd?define(["leaflet"],function(e){return e.MarkerClusterGroup.LayerSupport=r(e)}):"object"==typeof module&&module.exports?module.exports=r(require("leaflet")):e.L.MarkerClusterGroup.LayerSupport=r(e.L)}(this,function(e){var r=e.MarkerClusterGroup,t=r.prototype;r.LayerSupport=r.extend({statics:{version:"1.0.0"},options:{singleAddRemoveBufferDuration:100},initialize:function(e){t.initialize.call(this,e),this._originalAddLayer=t.addLayer,this._originalAddLayers=t.addLayers,this._originalRemoveLayer=t.removeLayer,this._originalRemoveLayers=t.removeLayers,this._featureGroup=new r.LayerSupport.ByPassingFeatureGroup,this._featureGroup.addEventParent(this),this._nonPointGroup=new r.LayerSupport.ByPassingFeatureGroup,this._nonPointGroup.addEventParent(this),this._layers={},this._proxyLayerGroups={},this._proxyLayerGroupsNeedRemoving={},this._singleAddRemoveBuffer=[]},checkIn:function(e){var r=this._toArray(e);return this._checkInGetSeparated(r),this},checkOut:function(r){var t,o,a=this._toArray(r),i=this._separateSingleFromGroupLayers(a,{groups:[],singles:[]}),s=i.groups,n=i.singles;for(o=0;o<n.length;o++)t=n[o],delete this._layers[e.stamp(t)],delete t._mcgLayerSupportGroup;for(this._originalRemoveLayers(n),o=0;o<s.length;o++)t=s[o],this._dismissProxyLayerGroup(t);return this},addLayer:function(e){return this._bufferSingleAddRemove(e,"addLayers"),this},addLayers:function(r){var t,o,a,i=this._toArray(r),s=this._checkInGetSeparated(i),n=s.groups;for(this._originalAddLayers(s.singles),a=0;a<n.length;a++)t=n[a],o=e.stamp(t),this._proxyLayerGroups[o]=t,delete this._proxyLayerGroupsNeedRemoving[o],this._map&&this._map._originalAddLayer(t)},removeLayer:function(e){return this._bufferSingleAddRemove(e,"removeLayers"),this},removeLayers:function(r){var t,o,a,i=this._toArray(r),s=this._separateSingleFromGroupLayers(i,{groups:[],singles:[]}),n=s.groups,p=s.singles;for(this._originalRemoveLayers(p),a=0;a<n.length;a++)t=n[a],o=e.stamp(t),delete this._proxyLayerGroups[o],this._map?this._map._originalRemoveLayer(t):this._proxyLayerGroupsNeedRemoving[o]=t;return this},onAdd:function(o){o._originalAddLayer=o._originalAddLayer||o.addLayer,o._originalRemoveLayer=o._originalRemoveLayer||o.removeLayer,e.extend(o,r.LayerSupport.LayerSwitchMap);var a,i,s,n=this._removePreAddedLayers(o);t.onAdd.call(this,o);for(a in this._proxyLayerGroups)i=this._proxyLayerGroups[a],o._originalAddLayer(i);for(a in this._proxyLayerGroupsNeedRemoving)i=this._proxyLayerGroupsNeedRemoving[a],o._originalRemoveLayer(i),delete this._proxyLayerGroupsNeedRemoving[a];for(s=0;s<n.length;s++)o.addLayer(n[s])},_checkInGetSeparated:function(r){var t,o,a=this._separateSingleFromGroupLayers(r,{groups:[],singles:[]}),i=a.groups,s=a.singles;for(o=0;o<i.length;o++)t=i[o],this._recruitLayerGroupAsProxy(t);for(o=0;o<s.length;o++)t=s[o],this._removeFromOtherGroupsOrMap(t),this._layers[e.stamp(t)]=t,t._mcgLayerSupportGroup=this;return a},_separateSingleFromGroupLayers:function(r,t){for(var o,a=t.groups,i=t.singles,s=e.Util.isArray,n=0;n<r.length;n++)o=r[n],o instanceof e.LayerGroup?(a.push(o),this._separateSingleFromGroupLayers(o.getLayers(),t)):s(o)?this._separateSingleFromGroupLayers(o,t):i.push(o);return t},_dismissProxyLayerGroup:function(r){if(void 0!==r._proxyMCGLayerSupportGroup&&r._proxyMCGLayerSupportGroup===this){delete r._proxyMCGLayerSupportGroup,r.addLayer=r._originalAddLayer,r.removeLayer=r._originalRemoveLayer;var t=e.stamp(r);delete this._proxyLayerGroups[t],delete this._proxyLayerGroupsNeedRemoving[t],this._removeFromOwnMap(r)}},_recruitLayerGroupAsProxy:function(t){var o=t._proxyMCGLayerSupportGroup;if(o){if(o===this)return;o.checkOut(t)}else this._removeFromOwnMap(t);t._proxyMCGLayerSupportGroup=this,t._originalAddLayer=t._originalAddLayer||t.addLayer,t._originalRemoveLayer=t._originalRemoveLayer||t.removeLayer,e.extend(t,r.LayerSupport.ProxyLayerGroup)},_removeFromOtherGroupsOrMap:function(e){var r=e._mcgLayerSupportGroup;if(r){if(r===this)return;r.checkOut(e)}else e.__parent?e.__parent._group.removeLayer(e):this._removeFromOwnMap(e)},_removeFromOwnMap:function(e){e._map&&e._map.removeLayer(e)},_removePreAddedLayers:function(e){var r,t=this._layers,o=[];for(var a in t)r=t[a],r._map&&(o.push(r),e._originalRemoveLayer(r));return o},_bufferSingleAddRemove:function(r,t){var o,a=this.options.singleAddRemoveBufferDuration;a>0?(this._singleAddRemoveBuffer.push({type:t,layer:r}),this._singleAddRemoveBufferTimeout||(o=e.bind(this._processSingleAddRemoveBuffer,this),this._singleAddRemoveBufferTimeout=setTimeout(o,a))):this[t](r)},_processSingleAddRemoveBuffer:function(){var e,r,t,o=this._singleAddRemoveBuffer,a=[];for(t=0;t<o.length;t++)e=o[t],r||(r=e.type),e.type===r?a.push(e.layer):(this[r](a),a=[e.layer]);this[r](a),o.length=0,clearTimeout(this._singleAddRemoveBufferTimeout),this._singleAddRemoveBufferTimeout=null},_toArray:function(r){return e.Util.isArray(r)?r:[r]}}),e.markerClusterGroup.layerSupport=function(e){return new r.LayerSupport(e)};var r=e.MarkerClusterGroup;r.LayerSupport.ByPassingFeatureGroup=e.FeatureGroup.extend({addLayer:function(r){if(this.hasLayer(r))return this;r.addEventParent(this);var t=e.stamp(r);return this._layers[t]=r,this._map&&this._map._originalAddLayer(r),this.fire("layeradd",{layer:r})},removeLayer:function(r){if(!this.hasLayer(r))return this;r in this._layers&&(r=this._layers[r]),r.removeEventParent(this);var t=e.stamp(r);return this._map&&this._layers[t]&&this._map._originalRemoveLayer(this._layers[t]),delete this._layers[t],this.fire("layerremove",{layer:r})},onAdd:function(e){this._map=e,this.eachLayer(e._originalAddLayer,e)},onRemove:function(e){this.eachLayer(e._originalRemoveLayer,e),this._map=null}});var r=e.MarkerClusterGroup;r.LayerSupport.ProxyLayerGroup={addLayer:function(e){var r=this.getLayerId(e);return this._layers[r]=e,this._map?this._proxyMCGLayerSupportGroup.addLayer(e):this._proxyMCGLayerSupportGroup.checkIn(e),this},removeLayer:function(e){var r=e in this._layers?e:this.getLayerId(e);return this._proxyMCGLayerSupportGroup.removeLayer(e),delete this._layers[r],this}};var r=e.MarkerClusterGroup;return r.LayerSupport.LayerSwitchMap={addLayer:function(e){return e._mcgLayerSupportGroup?e._mcgLayerSupportGroup._originalAddLayer(e):this._originalAddLayer(e)},removeLayer:function(e){return e._mcgLayerSupportGroup?e._mcgLayerSupportGroup._originalRemoveLayer(e):this._originalRemoveLayer(e)}},e.MarkerClusterGroup.LayerSupport});